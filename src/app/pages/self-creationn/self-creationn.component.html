<div class="container">
  <p-toast></p-toast>

  <p-card header="Application Form" styleClass="p-shadow-8">
    <p-steps [model]="items" [readonly]="false" [(activeIndex)]="activeIndex"></p-steps>

    <form (ngSubmit)="onSubmit()" #applicationForm="ngForm" class="p-fluid">
      <!-- Step 1: Personal Information -->
      <div *ngIf="activeIndex === 0" class="p-grid p-fluid">
        <div class="p-col-12 p-md-6">
          <label for="matricule">Matricule</label>
          <input pInputText id="matricule" [(ngModel)]="application.matricule" name="matricule" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="firstName">First Name</label>
          <input pInputText id="firstName" [(ngModel)]="application.firstName" name="firstName" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="lastName">Last Name</label>
          <input pInputText id="lastName" [(ngModel)]="application.lastName" name="lastName" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="nationality">Nationality</label>
          <p-dropdown
            id="nationality"
          [options]="nationalities"
          [(ngModel)]="application.nationality"
          name="nationality"
          placeholder="Select Nationality"
          required>
          </p-dropdown>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="regionOfOrigin">Region of Origin</label>
          <p-dropdown
            id="regionOfOrigin"
          [options]="regions"
          [(ngModel)]="application.regionOfOrigin"
          name="regionOfOrigin"
          placeholder="Select Region"
          required>
          </p-dropdown>
        </div>

        <div class="p-col-12">
          <label for="address">Address</label>
          <input pInputText id="address" [(ngModel)]="application.address" name="address" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="whatsappNumber">WhatsApp Number</label>
          <input pInputText id="whatsappNumber" [(ngModel)]="application.whatsappNumber" name="whatsappNumber" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="email">Email</label>
          <input pInputText id="email" type="email" [(ngModel)]="application.email" name="email" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="dateOfBirth">Date of Birth</label>
          <p-calendar id="dateOfBirth" [(ngModel)]="application.dateOfBirth" name="dateOfBirth"
                      [showIcon]="true" required></p-calendar>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="phoneNumber">Phone Number</label>
          <input pInputText id="phoneNumber" [(ngModel)]="application.phoneNumber" name="phoneNumber" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="program">Program</label>
          <p-dropdown
            id="program"
          [options]="programs"
          [(ngModel)]="application.program"
          name="program"
          placeholder="Select Program"
          required>
          </p-dropdown>
        </div>
      </div>

      <!-- Step 2: Family Details -->
      <div *ngIf="activeIndex === 1" class="p-grid p-fluid">
        <div class="p-col-12 p-md-6">
          <label for="fatherName">Father's Name</label>
          <input pInputText id="fatherName" [(ngModel)]="application.familyDetails.fatherName" name="fatherName" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="fatherProfession">Father's Profession</label>
          <input pInputText id="fatherProfession" [(ngModel)]="application.familyDetails.fatherProfession" name="fatherProfession" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="fatherPhone">Father's Phone</label>
          <input pInputText id="fatherPhone" [(ngModel)]="application.familyDetails.fatherPhone" name="fatherPhone" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="motherName">Mother's Name</label>
          <input pInputText id="motherName" [(ngModel)]="application.familyDetails.motherName" name="motherName" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="motherProfession">Mother's Profession</label>
          <input pInputText id="motherProfession" [(ngModel)]="application.familyDetails.motherProfession" name="motherProfession" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="motherPhone">Mother's Phone</label>
          <input pInputText id="motherPhone" [(ngModel)]="application.familyDetails.motherPhone" name="motherPhone" required>
        </div>
      </div>

      <!-- Step 3: Education Details -->
      <div *ngIf="activeIndex === 2" class="p-grid p-fluid">
        <div class="p-col-12 p-md-6">
          <label for="hasAL">Has AL</label>
          <p-checkbox id="hasAL" [(ngModel)]="application.educationDetails.hasAL" name="hasAL"
                      binary="true"></p-checkbox>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="upperSixthSeries">Upper Sixth Series</label>
          <input pInputText id="upperSixthSeries" [(ngModel)]="application.educationDetails.upperSixthSeries" name="upperSixthSeries" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="totalNumberInClass">Total Number in Class</label>
          <input pInputText id="totalNumberInClass" type="number" [(ngModel)]="application.educationDetails.totalNumberInClass" name="totalNumberInClass" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="school">School</label>
          <input pInputText id="school" [(ngModel)]="application.educationDetails.school" name="school" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="repeatedClass">Repeated Class</label>
          <p-checkbox id="repeatedClass" [(ngModel)]="application.educationDetails.repeatedClass" name="repeatedClass"
                      binary="true"></p-checkbox>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="alGrades">AL Grades</label>
          <input pInputText id="alGrades" [(ngModel)]="application.educationDetails.alGrades" name="alGrades" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="olGrades">OL Grades</label>
          <input pInputText id="olGrades" [(ngModel)]="application.educationDetails.olGrades" name="olGrades" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="termPositions">Term Positions</label>
          <input pInputText id="termPositions" [(ngModel)]="application.educationDetails.termPositions" name="termPositions" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="chosenWritingCenter">Chosen Writing Center</label>
          <input pInputText id="chosenWritingCenter" [(ngModel)]="application.educationDetails.chosenWritingCenter" name="chosenWritingCenter" required>
        </div>

        <div class="p-col-12 p-md-6">
          <label for="chosenField">Chosen Field</label>
          <input pInputText id="chosenField" [(ngModel)]="application.educationDetails.chosenField" name="chosenField" required>
        </div>
      </div>

      <!-- Step 4: Documents Upload -->
      <div *ngIf="activeIndex === 3" class="p-grid p-fluid">
        <div class="p-col-12">
          <h3>Required Documents</h3>
          <p class="p-mb-4">Please upload the following documents (Max size: 2MB each, Accepted formats: PDF, JPG, PNG):</p>

          <div *ngFor="let doc of documentUploads; let i = index" class="p-field p-grid p-mb-4">
            <div class="p-col-12 p-md-3">
              <label [for]="'docType_' + i" class="p-text-bold">
                {{ doc.description }}
                <span *ngIf="doc.required" style="color: red;">*</span>
              </label>
            </div>
            <div class="p-col-12 p-md-9">
              <p-fileUpload
                [id]="'docType_' + i"
                [name]="'document_' + i"
                mode="basic"
                [chooseLabel]="doc.file ? 'Change File' : 'Select File'"
                (onSelect)="onFileSelect($event, i)"
                (onRemove)="onFileRemove(i)"
                [showUploadButton]="false"
                [showCancelButton]="false"
                accept=".pdf,.jpg,.jpeg,.png"
                maxFileSize="2000000"
                styleClass="p-mb-2">
              </p-fileUpload>

              <small *ngIf="doc.file" class="p-text-secondary p-d-flex p-ai-center">
                <i class="pi pi-file p-mr-2"></i>
                {{ doc.file.name }} ({{ (doc.file.size / 1024).toFixed(2) }} KB)
                <button pButton pRipple
                        type="button"
                        icon="pi pi-times"
                        class="p-button-text p-button-sm p-ml-2"
                        (click)="onFileRemove(i)"></button>
              </small>
            </div>
          </div>

          <div class="p-col-12 p-mt-4" *ngIf="uploading">
            <p-progressBar [value]="uploadProgress" [showValue]="true"></p-progressBar>
            <small class="p-text-secondary">Uploading documents... {{uploadProgress}}%</small>
          </div>

          <div class="p-col-12 p-mt-2">
            <p class="p-text-secondary">
              Documents uploaded: {{getUploadedFilesCount()}} of {{getTotalRequiredDocuments()}} required
            </p>
          </div>
        </div>
      </div>

      <!-- Step 5: Review & Submit -->
      <div *ngIf="activeIndex === 4" class="p-grid p-fluid">
        <div class="p-col-12">
          <h3>Review Your Information</h3>
          <p-card>
            <div class="p-grid">
              <div class="p-col-12 p-md-6">
                <h4>Personal Information</h4>
                <p><strong>Name:</strong> {{application.firstName}} {{application.lastName}}</p>
                <p><strong>Matricule:</strong> {{application.matricule}}</p>
                <p><strong>Nationality:</strong> {{application.nationality}}</p>
                <p><strong>Region:</strong> {{application.regionOfOrigin}}</p>
                <p><strong>Email:</strong> {{application.email}}</p>
                <p><strong>Phone:</strong> {{application.phoneNumber}}</p>
                <p><strong>Program:</strong> {{application.program}}</p>
              </div>

              <div class="p-col-12 p-md-6">
                <h4>Family Details</h4>
                <p><strong>Father's Name:</strong> {{application.familyDetails.fatherName}}</p>
                <p><strong>Father's Profession:</strong> {{application.familyDetails.fatherProfession}}</p>
                <p><strong>Mother's Name:</strong> {{application.familyDetails.motherName}}</p>
                <p><strong>Mother's Profession:</strong> {{application.familyDetails.motherProfession}}</p>
              </div>

              <div class="p-col-12 p-mt-3">
                <h4>Education Details</h4>
                <p><strong>School:</strong> {{application.educationDetails.school}}</p>
                <p><strong>Has AL:</strong> {{application.educationDetails.hasAL ? 'Yes' : 'No'}}</p>
                <p><strong>AL Grades:</strong> {{application.educationDetails.alGrades}}</p>
                <p><strong>OL Grades:</strong> {{application.educationDetails.olGrades}}</p>
              </div>

              <div class="p-col-12 p-mt-3">
                <h4>Documents</h4>
                <p-table [value]="documentUploads" [responsive]="true" styleClass="p-datatable-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Document Type</th>
                      <th>Status</th>
                      <th>File Name</th>
                      <th>Size</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-doc>
                    <tr>
                      <td>{{doc.description}}</td>
                      <td>
                        <span [class]="doc.file ? 'p-badge p-mr-2 p-badge-success' : 'p-badge p-mr-2 p-badge-danger'">
                          {{doc.file ? 'Uploaded' : 'Missing'}}
                        </span>
                      </td>
                      <td>{{doc.file ? doc.file.name : '--'}}</td>
                      <td>{{doc.file ? (doc.file.size / 1024).toFixed(2) + ' KB' : '--'}}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="p-col-12 p-mt-4">
        <div class="p-d-flex p-jc-between">
          <button pButton type="button" label="Previous" icon="pi pi-arrow-left"
                  (click)="prevStep()" *ngIf="activeIndex !== 0"
                  class="p-button-secondary"></button>

          <button pButton type="button" label="Next" icon="pi pi-arrow-right" iconPos="right"
                  (click)="nextStep()" *ngIf="activeIndex !== items.length - 1"
                  [disabled]="!isCurrentStepValid()"
                  class="p-button-primary"></button>

          <button pButton type="submit" label="{{uploading ? 'Uploading...' : 'Submit'}}"
                  icon="pi pi-check" iconPos="right"
                  *ngIf="activeIndex === items.length - 1"
                  [disabled]="!applicationForm.form.valid || uploading"
                  class="p-button-success">
            <i class="pi pi-spinner pi-spin" *ngIf="uploading"></i>
          </button>
        </div>
      </div>
    </form>
  </p-card>
</div>
